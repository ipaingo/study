<html></html>
<head>
    <style>
        table {
            border-collapse: collapse;
            border-spacing: 0px;
        }
        table, th, td {
            padding: 2px;
            border: 1px solid black;
            text-align: center;
        }
    </style>
</head>
<body>
    <input type="button" onclick="location.href='/add_document_menu'" value="Ввод и отображение" />
    <input type="button" onclick="location.href='/aggregate_document_menu'" value="Агрегация и вывод" />
    <br/>
    <br/>
    Коллекция: <input type="button" value="Команды" id="collection_change_button"/><br/>
    <table id="documents_table"></table>
    Ключ: <input type="text" id="key_input">
    <span id="key_input_err"></span><br/>
    Знак сравнения: <select id="compare_select">
        <option value=">">></option>
        <option value=">=">>=</option>
        <option value="=">=</option>
        <option value="<="><=</option>
        <option value="<"><</option>
    </select><br/>
    Значение: <input type="text" id="value_input">
    <span id="value_input_err"></span><br/><br/>
    <input type="button" id="filtrate_button"  value="Фильтрация"><br/>

    <script>
        const collection_change_button = document.getElementById("collection_change_button")
        const documents_table = document.getElementById("documents_table")
        const key_input = document.getElementById("key_input")
        const value_input = document.getElementById("value_input")
        const compare_select = document.getElementById("compare_select")
        const key_input_err = document.getElementById("key_input_err")
        const value_input_err = document.getElementById("value_input_err")
        const filtrate_button = document.getElementById("filtrate_button")

        let cur_collection = ""

        let cur_document_template = {}

        collection_change_button.onclick = async function () {
            if (cur_collection == "teams") {
                cur_collection = "games"
                this.value = "Игры"
                cur_document_template = game_template
            } else {
                cur_collection = "teams"
                this.value = "Команды"
                cur_document_template = team_template
            }

            const res = await (await fetch(`/get_documents?collection=${cur_collection}`)).json()
            show_documents(res.documents)
        }

        async function show_documents(res) {
            documents_table.innerHTML = ""
            
            
            documents_table.innerHTML = ""
            const thead = document.createElement("thead")
            documents_table.appendChild(thead)
            const tbody = document.createElement("thead")
            documents_table.appendChild(tbody)
            const tp = cur_document_template
            const kss = Object.keys(tp)
            const tr1 = document.createElement("tr")
            for (const k of kss) {
                const th = document.createElement("th")
                if (typeof tp[k] == "object") {
                    th.colSpan = Object.keys(tp[k][0]).length
                } else {
                    th.rowSpan = 2
                }
                th.innerText = k
                tr1.appendChild(th)
            }
            thead.appendChild(tr1)
            const tr2 = document.createElement("tr")
            for (const k of kss) {
                if (typeof tp[k] == "object") {
                    for (const kk of Object.keys(tp[k][0])) {
                        const th = document.createElement("th")
                        th.innerText = kk
                        tr2.appendChild(th)
                    }
                }
            }
            thead.appendChild(tr2)

            for (const doc of res) {
                const tp = cur_document_template
                const kss = Object.keys(tp)
                const rs = Math.max(...kss.map((obj) => {
                    if (doc[obj]?.constructor != Array)
                        return 1
                    return doc[obj]?.length || 0
                })) || 1

                const tr = document.createElement("tr")
                const append_this_sh_row = (tp, sh, tr) => {
                    if (tp.constructor != Array) {
                        const td_tp = document.createElement("td")
                        td_tp.innerText = sh || tp
                        td_tp.rowSpan = rs
                        tr.appendChild(td_tp)
                        return
                    }
                    const ks = Object.keys(tp[0])
                    if (sh?.length > 0) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[0][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }
                const append_this_sh_row2 = (tp, sh, i, tr) => {
                    if (tp.constructor != Array)
                        return
                    const ks = Object.keys(tp[0])
                    if (i < sh?.length) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[i][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }

                for (const k of kss) {
                    append_this_sh_row(cur_document_template[k], doc[k], tr)
                }

                documents_table.lastChild.appendChild(tr)
                
                for (let i = 1; i < rs; i++) {
                    const tr = document.createElement("tr")

                    for (const k of kss) {
                        append_this_sh_row2(cur_document_template[k], doc[k], i, tr)
                    }

                    documents_table.lastChild.appendChild(tr)
                }
            }
        }
        
        function input_key_err(str = "") {
            key_input_err.innerHTML = str
        }
        function input_value_err(str = "") {
            value_input_err.innerHTML = str
        }

        filtrate_button.onclick = async function() {
            let compare

            switch (compare_select.value) {
                case (">"): compare = "gt"; break;
                case (">="): compare = "gte"; break;
                case ("<"): compare = "lt"; break;
                case ("<="): compare = "lte"; break;
                case ("="): compare = "eq"; break;
            }

            const res = await (await fetch(`/get_documents?collection=${cur_collection}&key=${key_input.value}&value=${value_input.value}&compare=${compare}`)).json()
            show_documents(res.documents)

            // const res = await (await fetch(`/get_documents?collection=${cur_collection}`)).json()
            // let bad_check = Array(res.documents.length)
            // console.log(bad_check)

            // input_key_err()
            // input_value_err()

            // if (key_input.value == "") {
            //     show_documents(res)
            //     return
            // }

            // let keys = key_input.value.split(".")
            // let value = value_input.value
            // let cur_template = cur_document_template
            // let cur_docs_nests = Array(res.documents.length)
            // for (let i = 0; i < cur_docs_nests.length; i++)
            //     cur_docs_nests[i] = res.documents[i]

            // for (let i = 0; i < keys.length; i++) {
            //     let key = keys[i];
            //     if (!key) {
            //         input_key_err("Key cannot be null")
            //         return
            //     }
            //     let tp_key = key

            //     if (cur_template?.constructor == Array) {
            //         key = parseInt(key)
            //         if (Number.isNaN(key)) {
            //             input_key_err("Key for array should be a number")
            //             return
            //         }
            //         if (key < 0) {
            //             input_key_err(`Key "${key}" is in wrong range`)
            //             return
            //         }
            //         tp_key = 0
            //     }

            //     if (cur_template && cur_template[tp_key] != undefined) {

            //     } else {
            //         input_key_err(`No such a key "${key}" in template`)
            //         return
            //     }
            //     if (i == keys.length - 1) {
            //         if (cur_template[tp_key].constructor == Object) {
            //             input_key_err(`Cannot compare object keys`)
            //             return
            //         }

            //         let val = cur_template[tp_key].constructor(value)
            //         if ((cur_template[tp_key]?.constructor == Number || cur_template[tp_key]?.constructor == Array) && Number.isNaN(val)) {
            //             input_value_err(`Invalid value input`)
            //             return
            //         }

            //         for (let i = 0; i < bad_check.length; i++) {
            //             if (bad_check[i] == undefined) {
            //                 console.log(cur_docs_nests[i])
            //                 let cmp_value = cur_docs_nests[i][key]
            //                 if (cmp_value.constructor == Array)
            //                     cmp_value = cmp_value.length

            //                 let check = true
                            
            //                 switch (compare_select.value) {
            //                     case (">"): check = (cmp_value > val); break;
            //                     case (">="): check = (cmp_value >= val); break;
            //                     case ("<"): check = (cmp_value < val); break;
            //                     case ("<="): check = (cmp_value <= val); break;
            //                     case ("="): check = (cmp_value == val); break;
            //                 }

            //                 if (!check) {
            //                     bad_check[i] = true 
            //                 }
            //             }
            //         }

            //         break;
            //     }

            //     for (let i = 0; i < bad_check.length; i++) {
            //         if (bad_check[i] == undefined) {
            //             if (cur_docs_nests[i][key] == undefined) {
            //                 bad_check[i] = true
            //             } else {
            //                 cur_docs_nests[i] = cur_docs_nests[i][key]
            //             }
            //         }
            //     }

            //     cur_template = cur_template[tp_key]
            // }
            
            // let ans = []
            // for (let i = 0; i < bad_check.length; i++) {
            //     if (bad_check[i] == undefined) {
            //         ans.push(res.documents[i])
            //     }
            // }
            // show_documents(ans)
        }



        
        const team_template = {
            name: "",
            city: "",
            coach: "",
            players: [{
                name: "",
                position: 0,
            }],
            reserve: [{
                name: "",
            }],
        }
        const game_template = {
            date: "",
            first_team_score: 0,
            second_team_score: 0,
            fouls: [{
                color: "red",
                minute: 0,
                player: "",
                reason: "",
            }],
            goals: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            penalties: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            shots_on_goal: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
        }
        
        collection_change_button.click()
        </script>
</script>
</body>