<html></html>
<head>
    <style>
        table {
            border-collapse: collapse;
            border-spacing: 0px;
        }
        table, th, td {
            padding: 2px;
            border: 1px solid black;
            text-align: center;
        }
    </style>
</head>
<body>
    <input type="button" onclick="location.href='/add_document_menu'" value="Ввод и отображение" />
    <input type="button" onclick="location.href='/filter_document_menu'" value="Поиск и фильтрация" />
    <br/>
    <br/>
    Коллекция: <input type="button" value="Команды" id="collection_change_button"/><br/>
    <table id="documents_table"></table>
    Запрос: <textarea type="text" id="query_input"></textarea>
    <span id="query_input_err"></span><br/>
    <input type="button" value="Отправить запрос" id="send_query_button"/><br/>
    Вывод: <textarea type="text" id="query_output" readonly></textarea>

    <script>
        const collection_change_button = document.getElementById("collection_change_button")
        const documents_table = document.getElementById("documents_table")
        const query_input = document.getElementById("query_input")
        const query_input_err = document.getElementById("query_input_err")
        const query_output = document.getElementById("query_output")
        const send_query_button = document.getElementById("send_query_button")

        let cur_collection = ""

        let cur_document_template = {}

        collection_change_button.onclick = async function () {
            if (cur_collection == "teams") {
                cur_collection = "games"
                this.value = "Игры"
                cur_document_template = game_template
            } else {
                cur_collection = "teams"
                this.value = "Команды"
                cur_document_template = team_template
            }

            const res = await (await fetch(`/get_documents?collection=${cur_collection}`)).json()
            show_documents(res.documents)
        }

        async function show_documents(res) {
            documents_table.innerHTML = ""
            
            
            documents_table.innerHTML = ""
            const thead = document.createElement("thead")
            documents_table.appendChild(thead)
            const tbody = document.createElement("thead")
            documents_table.appendChild(tbody)
            const tp = cur_document_template
            const kss = Object.keys(tp)
            const tr1 = document.createElement("tr")
            for (const k of kss) {
                const th = document.createElement("th")
                if (typeof tp[k] == "object") {
                    th.colSpan = Object.keys(tp[k][0]).length
                } else {
                    th.rowSpan = 2
                }
                th.innerText = k
                tr1.appendChild(th)
            }
            thead.appendChild(tr1)
            const tr2 = document.createElement("tr")
            for (const k of kss) {
                if (typeof tp[k] == "object") {
                    for (const kk of Object.keys(tp[k][0])) {
                        const th = document.createElement("th")
                        th.innerText = kk
                        tr2.appendChild(th)
                    }
                }
            }
            thead.appendChild(tr2)

            for (const doc of res) {
                const tp = cur_document_template
                const kss = Object.keys(tp)
                const rs = Math.max(...kss.map((obj) => {
                    if (doc[obj]?.constructor != Array)
                        return 1
                    return doc[obj]?.length || 0
                })) || 1

                const tr = document.createElement("tr")
                const append_this_sh_row = (tp, sh, tr) => {
                    if (tp.constructor != Array) {
                        const td_tp = document.createElement("td")
                        td_tp.innerText = sh || tp
                        td_tp.rowSpan = rs
                        tr.appendChild(td_tp)
                        return
                    }
                    const ks = Object.keys(tp[0])
                    if (sh?.length > 0) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[0][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }
                const append_this_sh_row2 = (tp, sh, i, tr) => {
                    if (tp.constructor != Array)
                        return
                    const ks = Object.keys(tp[0])
                    if (i < sh?.length) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[i][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }

                for (const k of kss) {
                    append_this_sh_row(cur_document_template[k], doc[k], tr)
                }

                documents_table.lastChild.appendChild(tr)
                
                for (let i = 1; i < rs; i++) {
                    const tr = document.createElement("tr")

                    for (const k of kss) {
                        append_this_sh_row2(cur_document_template[k], doc[k], i, tr)
                    }

                    documents_table.lastChild.appendChild(tr)
                }
            }
        }
        
        function input_query_err(str = "") {
            query_input_err.innerHTML = str
        }

        send_query_button.onclick = async function() {
            input_query_err()
            query_output.innerText = ""
            
            let query
            try {
                query = JSON.parse(query_input.value)
            } catch (err) {
                input_query_err("Invalid JSON")
                return
            }

            console.log(query)

            const res = await (await fetch(`/query_documents?collection=${cur_collection}`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(query)
            })).json()

            if (res.error) {
                input_query_err("Invalid query")
                console.log(res.error)
                return
            }

            query_output.innerText = JSON.stringify(res.documents, null, 4)
        }



        
        const team_template = {
            name: "",
            city: "",
            coach: "",
            players: [{
                name: "",
                position: 0,
            }],
            reserve: [{
                name: "",
            }],
        }
        const game_template = {
            date: "",
            first_team_score: 0,
            second_team_score: 0,
            fouls: [{
                color: "red",
                minute: 0,
                player: "",
                reason: "",
            }],
            goals: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            penalties: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            shots_on_goal: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
        }
        
        collection_change_button.click()
        </script>
</script>
</body>