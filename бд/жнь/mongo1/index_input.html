<html></html>
<head>
    <style>
        table {
            border-collapse: collapse;
            border-spacing: 0px;
        }
        table, th, td {
            padding: 2px;
            border: 1px solid black;
            text-align: center;
        }
    </style>
</head>
<body>
    <input type="button" onclick="location.href='/filter_document_menu'" value="Поиск и фильтрация" />
    <input type="button" onclick="location.href='/aggregate_document_menu'" value="Агрегация и вывод" />
    <br/>
    <br/>

    Коллекция: <input type="button" value="Команды" id="collection_change_button"/><br/>
    Ключ: <input type="text" id="key_input">
    <span id="key_input_err"></span><br/>
    Значение: <input type="text" id="value_input">
    <span id="value_input_err"></span><br/><br/>
    <input type="button" id="add_key_value_button"  value="Добавить ключ-значение"><br/>
    <input type="button" id="save_document_button"  value="Сохранить документ"><span id="save_document_err"></span><br/>
    <input type="button" id="show_documents_button" value="Показать документы"><br/>
    <textarea id="cur_document_textarea" readonly rows="37" cols="36"></textarea>
    <!-- <ul id="documents_list"></ul> -->
    <table id="documents_table"></table>

    <script>
        const cur_document_textarea = document.getElementById("cur_document_textarea")
        const key_input = document.getElementById("key_input")
        const value_input = document.getElementById("value_input")
        const key_input_err = document.getElementById("key_input_err")
        const value_input_err = document.getElementById("value_input_err")
        const save_document_err = document.getElementById("save_document_err")
        const collection_change_button = document.getElementById("collection_change_button")
        const add_key_value_button = document.getElementById("add_key_value_button")
        const save_document_button = document.getElementById("save_document_button")
        const show_documents_button = document.getElementById("show_documents_button")
        // const documents_list = document.getElementById("documents_list")
        const documents_table = document.getElementById("documents_table")

        cur_document_textarea.value = "{\n}"
        let cur_collection = ""

        let cur_document = {}
        let cur_document_template = {}

        collection_change_button.onclick = function () {
            if (cur_collection == "teams") {
                cur_collection = "games"
                this.value = "Игры"
                cur_document_template = game_template
            } else {
                cur_collection = "teams"
                this.value = "Команды"
                cur_document_template = team_template
            }
            cur_document = {}
            cur_document_textarea.value = ""
            documents_table.innerHTML = ""
            cur_document_textarea.placeholder = JSON.stringify(cur_document_template, null, 4)
        }

        function input_key_err(str = "") {
            key_input_err.innerHTML = str
        }
        function input_value_err(str = "") {
            value_input_err.innerHTML = str
        }
        
        add_key_value_button.onclick = function() {
            input_key_err()
            input_value_err()
            let keys = key_input.value.split(".")
            let value = value_input.value
            let cur_template = cur_document_template
            let cur_nest = cur_document

            for (let i = 0; i < keys.length; i++) {
                let key = keys[i];
                if (!key) {
                    input_key_err("Key cannot be null")
                    return
                }
                let tp_key = key

                if (cur_template?.constructor == Array) {
                    key = parseInt(key)
                    if (Number.isNaN(key)) {
                        input_key_err("Key for array should be a number")
                        return
                    }
                    if (key < 0 || key > (cur_nest?.length || 0)) {
                        input_key_err(`Key "${key}" is in wrong range`)
                        return
                    }
                    tp_key = 0
                }

                if (cur_template && cur_template[tp_key] != undefined) {
                    if (cur_nest[key] == undefined)
                        cur_nest[key] = cur_template[tp_key].constructor()
                } else {
                    input_key_err(`No such a key "${key}" in template`)
                    return
                }
                if (i == keys.length - 1) {
                    if (typeof cur_template[tp_key] == "object") {
                        input_key_err(`Last key should be non-nested`)
                        return
                    }

                    let val = cur_template[tp_key].constructor(value)
                    if (cur_template[tp_key]?.constructor == Number && Number.isNaN(val)) {
                        input_value_err(`Invalid value input`)
                        return
                    }
                    cur_nest[key] = val
                }

                cur_template = cur_template[tp_key]
                cur_nest = cur_nest[key]
            }

            cur_document_textarea.value = JSON.stringify(cur_document, null, 4)
        }
        
        save_document_button.onclick = async function() {
            save_document_err.innerHTML = ""

            const res = await fetch("/save_document", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    collection: cur_collection,
                    document: cur_document,
                })
            })

            if (res.ok) {
                save_document_err.innerHTML = "Saved!"
            } else {
                save_document_err.innerHTML = "Something went wrong"
            }

            cur_document = {}
            cur_document_textarea.value = ""
            cur_document_textarea.placeholder = JSON.stringify(cur_document_template, null, 4)
        }

        show_documents_button.onclick = async function() {
            documents_table.innerHTML = ""
            const res = await (await fetch(`/get_documents?collection=${cur_collection}`)).json()
            
            documents_table.innerHTML = ""
            const thead = document.createElement("thead")
            documents_table.appendChild(thead)
            const tbody = document.createElement("thead")
            documents_table.appendChild(tbody)
            const tp = cur_document_template
            const kss = Object.keys(tp)
            const tr1 = document.createElement("tr")
            for (const k of kss) {
                const th = document.createElement("th")
                if (typeof tp[k] == "object") {
                    th.colSpan = Object.keys(tp[k][0]).length
                } else {
                    th.rowSpan = 2
                }
                th.innerText = k
                tr1.appendChild(th)
            }
            thead.appendChild(tr1)
            const tr2 = document.createElement("tr")
            for (const k of kss) {
                if (typeof tp[k] == "object") {
                    for (const kk of Object.keys(tp[k][0])) {
                        const th = document.createElement("th")
                        th.innerText = kk
                        tr2.appendChild(th)
                    }
                }
            }
            thead.appendChild(tr2)

            for (const doc of res.documents) {
                const tp = cur_document_template
                const kss = Object.keys(tp)
                const rs = Math.max(...kss.map((obj) => {
                    if (doc[obj]?.constructor != Array)
                        return 1
                    return doc[obj]?.length || 0
                })) || 1

                const tr = document.createElement("tr")
                const append_this_sh_row = (tp, sh, tr) => {
                    if (tp.constructor != Array) {
                        const td_tp = document.createElement("td")
                        td_tp.innerText = sh || tp
                        td_tp.rowSpan = rs
                        tr.appendChild(td_tp)
                        return
                    }
                    const ks = Object.keys(tp[0])
                    if (sh?.length > 0) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[0][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }
                const append_this_sh_row2 = (tp, sh, i, tr) => {
                    if (tp.constructor != Array)
                        return
                    const ks = Object.keys(tp[0])
                    if (i < sh?.length) {
                        for (const k of ks) {
                            const td_k = document.createElement("td")
                            td_k.innerHTML = sh[i][k] || tp[0][k]
                            tr.appendChild(td_k)
                        }
                    } else {
                        const td_tp = document.createElement("td")
                        td_tp.colSpan = ks.length
                        tr.appendChild(td_tp)
                    }
                }

                for (const k of kss) {
                    append_this_sh_row(cur_document_template[k], doc[k], tr)
                }

                documents_table.lastChild.appendChild(tr)
                
                for (let i = 1; i < rs; i++) {
                    const tr = document.createElement("tr")

                    for (const k of kss) {
                        append_this_sh_row2(cur_document_template[k], doc[k], i, tr)
                    }

                    documents_table.lastChild.appendChild(tr)
                }
            }
        
            // for (const doc of res.documents) {
            //     const li = document.createElement("li")
            //     li.innerText = JSON.stringify(doc)
            //     documents_list.appendChild(li)
            // }
        }
        
        
        
        
        const team_template = {
            name: "",
            city: "",
            coach: "",
            players: [{
                name: "",
                position: 0,
            }],
            reserve: [{
                name: "",
            }],
        }
        const game_template = {
            date: "",
            first_team_score: 0,
            second_team_score: 0,
            fouls: [{
                color: "red",
                minute: 0,
                player: "",
                reason: "",
            }],
            goals: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            penalties: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
            shots_on_goal: [{
                position: "",
                minute: 0,
                player: "",
                pass: "",
            }],
        }
        
        collection_change_button.click()
        </script>



<!-- <input type="button" onclick="test()"> -->
<script>
    function test() {
        if (cur_collection == "teams") {
            key_input.value = "name"
            value_input.value = "aboba"
            add_key_value_button.click()
            key_input.value = "coach"
            value_input.value = "aboba2"
            add_key_value_button.click()
            key_input.value = "players.0.name"
            value_input.value = "aboba"
            add_key_value_button.click()
            key_input.value = "players.0.position"
            value_input.value = "1"
            add_key_value_button.click()
            key_input.value = "players.1.name"
            value_input.value = "aboba2"
            add_key_value_button.click()
            key_input.value = "players.1.position"
            value_input.value = "2"
            add_key_value_button.click()
            key_input.value = "reserve.0.name"
            value_input.value = "aboba3"
            add_key_value_button.click()
        } else if (cur_collection == "games") {
            key_input.value = "date"
            value_input.value = "11.11.11"
            add_key_value_button.click()
            key_input.value = "first_team_score"
            value_input.value = "1"
            add_key_value_button.click()
            key_input.value = "second_team_score"
            value_input.value = "1"
            add_key_value_button.click()
            key_input.value = "fouls.0.color"
            value_input.value = "red"
            add_key_value_button.click()
            key_input.value = "fouls.0.minute"
            value_input.value = "5"
            add_key_value_button.click()
            key_input.value = "fouls.0.player"
            value_input.value = "aboba"
            add_key_value_button.click()
            key_input.value = "fouls.0.reason"
            value_input.value = "because why not"
            add_key_value_button.click()
            key_input.value = "goals.0.position"
            value_input.value = "1"
            add_key_value_button.click()
            key_input.value = "goals.0.minute"
            value_input.value = "4"
            add_key_value_button.click()
            key_input.value = "goals.0.player"
            value_input.value = "aboba"
            add_key_value_button.click()
            key_input.value = "shots_on_goal.0.position"
            value_input.value = "6"
            add_key_value_button.click()
            key_input.value = "shots_on_goal.0.minute"
            value_input.value = "6"
            add_key_value_button.click()
            key_input.value = "shots_on_goal.0.player"
            value_input.value = "aboba2"
            add_key_value_button.click()
            key_input.value = "shots_on_goal.0.pass"
            value_input.value = "aboba"
            add_key_value_button.click()
        }
    }
</script>
</body>